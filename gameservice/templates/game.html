{% extends 'base.html' %}

{% block content %}

	{% for s in scores %}
	<p> Score: {{s.score}} by: {{s.player.username}}</p>
	{% endfor %}

<iframe id="freimi" src="{{game.url}}" height=800 width=90% name="iframe1"></iframe>
<br><br>

<div id="tekstit"><div>

<script>

window.addEventListener("message", function(evt) {

	// If LOAD, update the score
	if(evt.data.messageType === "SCORE") {

		// $.post("{% url 'save' game.id %}",
		// 	{
		// 		type: "SCORE",
		// 		score: event.data.score,
		// 		csrfmiddlewaretoken: '{{ csrf_token }}'
		// 	})

		var score = evt.data.score;

		$.ajax({
			url: "{% url 'submit_highscore' game.id %}",
			type: 'POST',
			data: {
				score: score,
				csrfmiddlewaretoken: '{{ csrf_token }}'
			},
			success: function(data) {
				console.log("score submitted: " + score);
			}

		});

	}

	else if (evt.data.messageType === "SAVE") {

		$.post("{% url 'save' game.id %}",
			{
				type: "SAVE",
				data: JSON.stringify(event.data.gameState),
				csrfmiddlewaretoken: '{{ csrf_token }}'
			})

		console.log("save submitted:" + event.data.gameState);
	}

	else if (evt.data.messageType === "LOAD_REQUEST") {

		$.get("{% url 'load' game.id %}", function(data) {

			$("#freimi").get(0).contentWindow.postMessage({
				"messageType" : "LOAD",
				"gameState" : JSON.parse(data) //this data is just the gamestate, see views.py
			}, "*");
		}).done(function() {
			$("#freimi").get(0).contentWindow.postMessage({
				"messageType" : "MESSAGE",
				"message" : "Game state loaded succesfully!"
			}, "*");
		}).fail(function() {
			$("#freimi").get(0).contentWindow.postMessage({
				"messageType" : "MESSAGE",
				"message" : "Loading game state failed."
			}, "*");
		});
	}


	// 	$.get("{% url 'load' game.id %}",
	// 	{
	// 		type: "LOAD_REQUEST",
	// 		csrfmiddlewaretoken: '{{ csrf_token }}'
	// 	}),
	//
	// 	function (data,status){
	// 		var message;
	//
	// 		if (data.length > 1) {
	// 			var obj = JSON.parse(data);
	// 			message = {messageType: "LOAD", gameState: obj} ;
	// 		}
	// 		else {
	// 			message = {messageType: "ERROR", info: "Gamestate could not be loaded"}
	// 		}
	// 		var iframe = getElementById("freimi");
	// 		freimi.contentWindow.postMessage(message, "{% url 'game_detail' game.id %}");
	// 	}
	// 	console.log("load request");
	// }

	else if (evt.data.messageType === "SETTING") {
		adjustIframe(evt.data.options.width, evt.data.options.height);
		changemessage("settings requested: " + evt.data.options.height + "x" + evt.data.options.width);
	}


});

	function changeMessage(msg) {
		document.getElementById("asd").innerHTML = msg;

	}
	function adjustIframe(x, y) {
	  document.getElementById("freimi").width = x;
	  document.getElementById("freimi").height = y;
	}




	// 	changemessage("Responded with load game with score of: " + gs.score );
	// 	var iframe = document.getElementById("freimi")
	// 	var x = iframe.contentWindow;
	// 	x.postMessage(msg, '*');
	// }

	function changemessage(msg) {
		var elem = document.getElementById("tekstit");
		elem.innerHTML += msg +"<br>";
	}

</script>

{% endblock %}
